From f7910a50f5b111c5ef83c2ebe1f46ccda602ff65 Mon Sep 17 00:00:00 2001
From: Matteo Bruni <mbruni@codeweavers.com>
Date: Thu, 18 Apr 2013 23:06:48 +0200
Subject: winex11.drv: Allow wglShareLists to succeed even if the context was
 made current.

---
 dlls/winex11.drv/opengl.c | 34 ++++++++++++++++++----------------
 1 file changed, 18 insertions(+), 16 deletions(-)

diff --git a/dlls/winex11.drv/opengl.c b/dlls/winex11.drv/opengl.c
index 6dd07fa..da68f01 100644
--- a/dlls/winex11.drv/opengl.c
+++ b/dlls/winex11.drv/opengl.c
@@ -1840,31 +1840,33 @@ static BOOL glxdrv_wglShareLists(struct wgl_context *org, struct wgl_context *de
      * current or when it hasn't shared display lists before.
      */
 
-    if((org->has_been_current && dest->has_been_current) || dest->has_been_current)
+    if (dest->sharing)
     {
-        ERR("Could not share display lists, one of the contexts has been current already !\n");
+        ERR("Could not share display lists because 'dest' has already shared lists before\n");
         return FALSE;
     }
-    else if(dest->sharing)
+    if (NtCurrentTeb()->glContext == dest)
     {
-        ERR("Could not share display lists because hglrc2 has already shared lists before\n");
+        FIXME("'dest' context is current.\n");
         return FALSE;
     }
-    else
+
+    if (dest->has_been_current)
     {
-        describeContext(org);
-        describeContext(dest);
+        FIXME("'dest' context has been current already, this might break terribly!\n");
+    }
 
-        /* Re-create the GLX context and share display lists */
-        pglXDestroyContext(gdi_display, dest->ctx);
-        dest->ctx = create_glxcontext(gdi_display, dest, org->ctx);
-        TRACE(" re-created an OpenGL context (%p) for Wine context %p sharing lists with OpenGL ctx %p\n", dest->ctx, dest, org->ctx);
+    describeContext(org);
+    describeContext(dest);
 
-        org->sharing = TRUE;
-        dest->sharing = TRUE;
-        return TRUE;
-    }
-    return FALSE;
+    /* Re-create the GLX context and share display lists */
+    pglXDestroyContext(gdi_display, dest->ctx);
+    dest->ctx = create_glxcontext(gdi_display, dest, org->ctx);
+    TRACE(" re-created an OpenGL context (%p) for Wine context %p sharing lists with OpenGL ctx %p\n", dest->ctx, dest, org->ctx);
+
+    org->sharing = TRUE;
+    dest->sharing = TRUE;
+    return TRUE;
 }
 
 static void wglFinish(void)
-- 
1.8.1.5

